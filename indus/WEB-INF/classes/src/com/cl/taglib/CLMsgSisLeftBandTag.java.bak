package com.cl.taglib;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import javax.servlet.jsp.tagext.*;

import java.util.*;
import java.io.*;

import com.cl.common.CLLoginControl;

import com.cl.testseries.TSQsets;			// will be in application scopre
import com.cl.testseries.TSStudentTests;	// will be in session scope
import com.cl.sis.student.SISStudentLogin;	// will be in session scope
import com.cl.sis.student.SISStudentLogin;	// will be in session scope

import java.sql.*;
import oracle.jdbc.driver.OracleTypes;

import org.apache.log4j.*;

/* # # # # # # # Pool Impl # # # # # # # */
import com.cl.sql.CLMSPoolManager;

public class CLMsgSisLeftBandTag extends TagSupport
{
	private int category;	// 1 = Employee; 0 = Customer/Student
	private int level;		// denotes Level of navigation for the categories
	//level 0 is the default level,
	//-1 has being used as a level on the clzone home page for employees, for jst the basic navigation
	//1 has been used in sis to go one level deeper in navigation

	private String newline;
	private static final String PKG_NAME = "clsite.com.cl.taglib";
	private Category logCategory;

	/* # # # # # # # Pool Impl # # # # # # # */
	private CLMSPoolManager clmsPool;
	private Connection connection;
	private CallableStatement cstmt;
	private CallableStatement _cstmt;
	private ResultSet rset;
	private int userId;

	private boolean connectionFromJsp = false;
	public void setCategory(String category)
	{
		try
		{
			this.category = Integer.parseInt(category);
		}
		catch (NumberFormatException nfe)
		{
			this.category = 0;
		}
	}

	public void setLevel(String level)
	{
		try
		{
			this.level = Integer.parseInt(level);
		}
		catch(NumberFormatException nfe)
		{
			this.level = 0;
		}
	}

	public void setConnObj(Connection connection)
	{
		this.connection = connection;
		connectionFromJsp = true;
	}


	public int doStartTag() throws JspTagException
	{
		JspWriter out = pageContext.getOut();
		clmsPool = CLMSPoolManager.getInstance();
		newline  = System.getProperty("line.separator");

		try
		{
			if (!connectionFromJsp)
			{
				connection = clmsPool.getConnection("erp");
			}
			if(category == 1)	// user is a CL Employee
				out.println(getClmsLeftBand());
			else
				out.println(getSisLeftBand());
		}
		catch(SQLException sql)
		{
			logCategory = Category.getInstance(PKG_NAME);
			logCategory.error(sql.toString());
		}
		catch(IOException ioe)
		{
			logCategory = Category.getInstance(PKG_NAME);
			logCategory.error(ioe.toString());
		}
		catch(Exception ex)
		{
			logCategory = Category.getInstance(PKG_NAME);
			logCategory.error(ex.toString());
		}

		finally
		{
			if (!connectionFromJsp)
			{
				clmsPool.freeConnection("erp",connection);
			}
		}
		return SKIP_BODY;
	}


	public String getSisLeftBand() throws SQLException
	{
		String inboxUrl = "";
		StringBuffer buffer = new StringBuffer(1000);

		TSQsets qsets = null;
		TSStudentTests dcatTests = null;
		TSStudentTests mockTests = null;
		TSStudentTests fltTests  = null;
		SISStudentLogin studentLogin = null;	// required to determine students enroll status

		try
		{
			inboxUrl = pageContext.getSession().getAttribute("inboxURL").toString();
		}
		catch(NullPointerException nlp)
		{
			inboxUrl = "/msg/MSGInbox.jsp?fid=1&fldr=Inbox";
		}

		buffer.append(newline + "<table width=\"100%\" cellspacing=\"0\"" + " cellpadding=\"0\" align=\"left\">");
        buffer.append(newline + "<tr><td colspan=\"3\" valign=\"top\">");
        buffer.append(newline + "<img src=\"/img/blank.gif\" height=\"8\"></td></tr>");
        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td>");
        buffer.append(newline + "<td colspan=\"2\" class=\"highlighttext\"><B>SIS Messaging System</B></td></tr>");

		// if the SIS Messaging is enabled for this user the inboxUrl will not
		// start with javascript
		if(!inboxUrl.startsWith("javascript"))
		{
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"10\"></td></tr>");
            buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td>");
            buffer.append(newline + "<td colspan=\"2\" class=\"highlighttext\"><B>Folders</B>");
            buffer.append(getFolders());
		}

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"10\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><font class=\"highlighttext\"><a href=\"/msg/MSGStudentCompose.jsp?qid=1&pid=2\" class=\"highlighttext\"><B>	Contact Your Teacher</B></a></font></td></tr>");

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><font class=\"highlighttext\"><a href=\"/msg/MSGStudentCompose.jsp?qid=28&pid=1\" class=\"highlighttext\"><B>	Principal's Desk</B></a></font></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
        buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><font class=\"lnkblubld\"><a href=\"/sis/ChangePwd.jsp\" class=\"highlighttext\"><B>Change Password</B></a></font></td></tr>");

		userId=Integer.parseInt(pageContext.getSession().getAttribute("uid").toString());

		Statement st = connection.createStatement();
		ResultSet rs= st.executeQuery("select enroll_id,school_id from cl_enroll enroll,cl_cust_login login,cl_web_user web where enroll.cust_id = login.cust_id and login.user_id = web.user_id and web.user_id = "+userId);
		rs.next();

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");

		buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><font class=\"lnkblubld\"><a class=\"highlighttext\" href=\"#\" title=\"View Student Detail\" onclick=\"javascript: OpenWindow('/viewStudentDetail.do?schoolEnrollId="+rs.getInt("enroll_id")+"&schoolId="+rs.getInt("school_id")+"','View_Student_Detail',650,500)\"><B>View Student</B></a></td></tr>");

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><a class=\"highlighttext\" href=\"#\" title=\"Edit Student Detail\" onclick=\"javascript: OpenWindow('/editStudentDetail.do?schoolEnrollId="+rs.getInt("enroll_id")+"&schoolId="+rs.getInt("school_id")+"','Edit_Student_Detail',650,500)\"><B>Edit Student</B></a></td></tr>");

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><a class=\"highlighttext\" href=\"#\" title=\"View Parent Detail\" onclick=\"javascript: OpenWindow('/viewParentDetail.do?schoolEnrollId="+rs.getInt("enroll_id")+"&schoolId="+rs.getInt("school_id")+"','View_Parent_Detail',650,500)\"><B>View Parent</B></a></td></tr>");

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><a class=\"highlighttext\" href=\"#\" title=\"Edit Parent Detail\" onclick=\"javascript: OpenWindow('/editParentDetail.do?schoolEnrollId="+rs.getInt("enroll_id")+"&schoolId="+rs.getInt("school_id")+"','Edit_Parent_Detail',650,500)\"><B>Edit Parent</B></a></td></tr>");

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><a class=\"highlighttext\" href=\"#\" title=\"Upload Photo\" onclick=\"javascript: OpenWindow('/clzone/apps/erp/image/StudentPhotoUploadForm.jsp?schoolEnrollId="+rs.getInt("enroll_id")+"&schoolId="+rs.getInt("school_id")+"','Upload_Photo',650,500)\"><B>Upload Photo</B></a></td></tr>");

		buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");

        buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
        buffer.append(newline + "<td colspan=\"2\" valign=\"top\"><font class=\"lnkblubld\"><a href=\"/sis/logout.jsp\" class=\"highlighttext\"><B>Logout</B></a></font><br><br></td></tr>");

		String str = buffer.toString() + "</table>";
		buffer = null;
		return str;
	}

	
	private String getProductLink()
	{
		String link  = "";
		String title = null;
		String url   = null;
		SISStudentLogin studentLogin = (SISStudentLogin) pageContext.getSession().getAttribute("StudentLogin");
		try
		{
			cstmt = connection.prepareCall("{call sis_student.get_prod_page(?,?,?,?)}");
			cstmt.setString(1, studentLogin.getProduct());
			cstmt.registerOutParameter(2, OracleTypes.VARCHAR);
			cstmt.registerOutParameter(3, OracleTypes.VARCHAR);
			cstmt.registerOutParameter(4, OracleTypes.VARCHAR);
			cstmt.execute();

			title = cstmt.getString(2);
			url   = cstmt.getString(3);
			try{cstmt.close();}catch(Exception ex1){}

			if(url == null || url.length() == 0 || title == null || title.length() == 0)
				link = "";
			else
				link = "<a href=\"" + url + "\" class=\"lnkblu\">" + title + "</a>";
		}
		catch(Exception exp)
		{
			link = "";
		}
		finally
		{
			try{cstmt.close();}	catch(SQLException sqle){}
		}
		return link;
	}

	private boolean chkTimekeeper(int empId, int locId)
	{
		boolean returnVal = false;
		PreparedStatement pstmt = null;
		String select = "select count(*) cnt from hris.cl_timekeeper where emp_id_timekeeper = ?";
		try
		{
			pstmt = connection.prepareStatement(select);
			pstmt.setInt(1,empId);
			rset = pstmt.executeQuery();
			rset.next();
			
			if (rset.getInt("cnt") > 0)
				returnVal = true;
			else
				returnVal = false;
		}
		catch (SQLException sql)
		{
			if(logCategory == null)
				logCategory = Category.getInstance(PKG_NAME);
			logCategory.error(sql.toString());
		}
		finally
		{
			try{rset.close();}catch(Exception ex){}
			try{pstmt.close();}catch(Exception ex){}
		}
		return returnVal;
	}

	// This method will be invoked for all employees i.e. category = 1;
	// This method will internally invoke the method getPrivileges() to know
	// what privileges the user has
	private String getClmsLeftBand() throws SQLException
	{
		com.cl.common.CLLoginControl loginControl = (com.cl.common.CLLoginControl) pageContext.getSession().getAttribute("loginControl");
		//Temp StringBuffer to store the generated HTML
		StringBuffer buffer = new StringBuffer(1000);
		// get the user privileges from the session
		String[] privilegeArray = getPrivileges();
		

		buffer.append(newline + "<table width=\"100%\" bgcolor=\"dfe1bc\" cellspacing=\"0\""
							  + " cellpadding=\"0\" align=\"left\">");
		buffer.append(newline + "<tr><td colspan=\"3\" valign=\"top\">");
		buffer.append(newline + "<img src=\"/img/blank.gif\" height=\"8\"></td></tr>");
		// if level is -1, it denotes the basic navigation and clms links are not required
		if(level>-1)
		{
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td>");
			buffer.append(newline + "<td colspan=\"2\" class=\"lnkbld\">CL Messaging<br>System 3.2</td></tr>");

			buffer.append(newline + "<tr><td colspan=\"3\" valign=\"top\">");
			buffer.append(newline + "<img src=\"/img/blank.gif\" height=\"8\"></td></tr>");

			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td>");
			buffer.append(newline + "<td colspan=\"2\" class=\"lnkbld\">Folders</td></tr>");

			buffer.append(getFolders());

			buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"10\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/MSGFolder.jsp?cat=" + category + "\""
							  + " title=\"CLMS Create Folder\" class=\"lnkbld\">Create Folder</a></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/MSGManageFolder.jsp?cat=" + category + "\""
							  + " title=\"CLMS Manage Folders\" class=\"lnkbld\">Manage Folders</a></td></tr>");

			buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/MSGStaffCompose.jsp\""
							  + " title=\"CLMS Compose Message\" class=\"lnkbld\">Compose Message</a></td></tr>");
			buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/MSGChannels.jsp?cat=1\""
							  + " title=\"CLMS Choose your channels\" class=\"lnkbld\">Choose Channels</a></td></tr>");
	
			//my address book
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/list/MSGCreateMemberBook.jsp?type=SYSTEM&display=full&cat=" + category + "\""
								  + " title=\"CLMS- Edit Address Book\" class=\"lnkbld\">Edit Address Book</a><font class=\"new\"> New!</font></td></tr>");

			//my group list
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/list/MSGCreateMemberBook.jsp?type=USER&display=full&cat=" + category + "\""
								  + " title=\"CLMS- Edit Group List\" class=\"lnkbld\">Edit Group List</a><font class=\"new\"> New!</font></td></tr>");

			//message retrieval utility link
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\"><img src=\"/img/blank.gif\" width=\"3\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/util/MSGRetrievalUtility.jsp?cat=" + category + "\""
								  + " title=\"CLMS Message Retrieval Utility\" class=\"lnkbld\">Message Retrieval Utility</a></td></tr>");

			buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td colspan=\"2\" valign=\"top\"><a href=\"/msg/MSGManual.jsp?cat=1\""
								  + " title=\"About CLMS\" class=\"lnkbld\">About CLMS</a><br><br></td></tr>");

			buffer.append(newline + "<tr bgcolor=\"#ffffff\"><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"3\" height=\"3\"></td></tr>");

			}

		buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
		if(level ==-1)// level -1 displays no. of unread messages if any with the clms link
		{
			int unread = 0;//unread are expected to be found in the session for this level
			unread = Integer.parseInt((String)pageContext.getSession().getAttribute("unread"));
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td><td colspan=\"2\"><a href=\"/msg/MSGInbox.jsp?cat=1&fid=S1&fldr=Inbox\""
							  + " title=\"CLMS\" class=\"lnkbld\">Go to CLMS</a>"+(unread>0?"<font class=\"highlighttext\"><b>("+unread+" New)</b></font>":"")+"</td></tr>");
		}
		else
		{
			buffer.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td><td colspan=\"2\"><a href=\"/clzone/login/CLZone.jsp\""
							  + " title=\"CL Zone Home\" class=\"lnkbld\">CL Zone Home</a></td></tr>");
		}

		for(int i=0;i<privilegeArray.length;i++)
		{
			if(privilegeArray[i].equals("ERP_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/CheckPrivilege.jsp?value=ERP_ADMIN\""
									  + " class=\"lnkbld\" title=\"ERP Admin\">ERP Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("ERP_ONLINE"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append("<td colspan=\"2\"><a href=\"/clzone/login/ERPOnline.jsp?value=ERP_ONLINE\" class=\"lnkbld\" title=\"Go To CL Online ERP Module\">Online ERP Zone</a></td></tr>");
			}
			if(privilegeArray[i].equals("MKTG_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/CheckPrivilege.jsp?value=MKTG_ADMIN\" " 
									  + "class=\"lnkbld\" title=\"Go To CL Marketing Admin Module\">Marketing</a></td></tr>");
			}
			if(privilegeArray[i].equals("AUDIT_REPORT"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/admin/erp/audit/CLAuditHome.jsp\" " 
									  + "class=\"lnkbld\" title=\"Go To View/Generate Audit Report\">Audit Reports</a></td></tr>");
			}

			if(privilegeArray[i].equals("REFUND_APP"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/apps/erp/refund\" " 
									  + "class=\"lnkbld\" title=\"Go To Refund Module\">Refund Module</a></td></tr>");
			}
			if(privilegeArray[i].equals("FRAN_APP"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/CheckPrivilege.jsp?value=FRAN_APP\""
									  + " title=\"Business Partner\" class=\"lnkbld\">Business Partner</a></td></tr>");
			}
			/*Added by giten for BA*/
			if(privilegeArray[i].equals("BUSS_ASS"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/CheckPrivilege.jsp?value=BUSS_ASS\""
									  + " title=\"Business Partner\" class=\"lnkbld\">Business Associates</a></td></tr>");
			}
			/*End*/
			/* ADDED BY DEV FOR FUTUREMAP - START */
			if(privilegeArray[i].equals("FMAP"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/apps/fmap/default.jsp\" "
									  + "class=\"lnkbld\" title=\"Go to Futuremap Zone\">Futuremap Zone</a></td></tr>");
			}
			/* ADDED BY DEV FOR FUTUREMAP - END */
			if(privilegeArray[i].equals("ACAD_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/CheckPrivilege.jsp?value=ACAD_ADMIN\" "
									  + "class=\"lnkbld\" title=\"Go to Institute Entry Module\">Institutes</a></td></tr>");
			}
			if(privilegeArray[i].equals("HR_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/clhr/admin/index.jsp\""
									  + " class=\"lnkbld\"  title=\"Go To HRIS Admin Module\">HR Admin</a></td></tr>");

			}
			if(privilegeArray[i].equals("HR_DEFAULT"))
			{
				/*Pranav Lal add add to make elis location independent*/
				//showElis=true; 
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/clhr/employee/index.jsp\" class=\"lnkbld\""  
									  + " title=\"Go To HR Information System\">HRIS</a> </td></tr>");

				//if(showElis)
				//{
					buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
					buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
					buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/apps/clhr/elis/default.jsp\" "
										  + "class=\"lnkbld\" title=\"ELIS Zone\">ELIS Zone</a>");
					int leaveCnt = getPendingLeaveCount(loginControl.getEmpId());
					int attdCnt  = getPendingAttdCount(loginControl.getEmpId());
					if (leaveCnt > 0)
					{
						buffer.append("<br><font class=\"lnkhed\">(" + leaveCnt + " leave app. pending)</font>");
					}
					if (attdCnt > 0)
					{
						buffer.append("<br><font class=\"lnkhed\">(" + attdCnt + " attd. req. pending)</font>");
					}
					buffer.append("</td></tr>");
				//}

				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/clhr/employee/policies/policies.jsp\""
									  + " class=\"lnkbld\"  title=\"Go To HR Information System\">" 
									  + "Corporate - Policies</a> <font class=\"new\">New !</font></td></tr>");
			}

			if(privilegeArray[i].equals("VIP_USER"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/vip\" class=\"lnkbld\" "
									  + "title=\"Add New VIP Details\">VIP DB</a></td></tr>");

				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/strategic_reports\" class=\"lnkbld\" "
									  + "title=\"Strategic Reports\">Strategic Reports</a></td></tr>");
			}
			if(privilegeArray[i].equals("IT_COMP"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/complaint/index.jsp\" class=\"lnkbld\" "
									  + "title=\"H/W, S/W Problem ? Register your problem\">H/W, S/W Problem ?</a></td></tr>");
			}
			if(privilegeArray[i].equals("IT_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/complaint/showattend.jsp\" class=\"lnkbld\" "
									  + "title=\"H/W, S/W Admin\">H/W, S/W Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("ESTORE_ADM"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=/clzone/cl.jsp?tp=\"CheckPrivilege.jsp?value=ESTORE_ADM\" class=\"lnkbld\" "
									  + "title=\"eStore Admin\">eStore Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("CC_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/CreditCards/index.jsp\" class=\"lnkbld\" "
									  + "title=\"Go To Credit Card Admin Module\">Credit Card Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("TS_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/ts/index.jsp\" class=\"lnkbld\" "
									  + "title=\"Go To Test Series Module\">Test Series Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("DOWNLOAD_SEC"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/download_section/index.jsp\" class=\"lnkbld\" "
									  + "title=\"Go To Download Section\">Download Section</a></td></tr>");
			}
			if(privilegeArray[i].equals("COMPL_SYS_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/complaint_system/index.jsp?status=PENDING\""
									  + " class=\"lnkbld\">Request System Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("WEB_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/CheckPrivilege.jsp?value=WEB_ADMIN\""
									  + " class=\"lnkbld\">Web Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("MATERIAL_INDENT"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/bp/IndentOrderMaterial.jsp?value=FRAN_APP\""
									  + " class=\"lnkbld\">Material Indent</a></td></tr>");
			}
			if(privilegeArray[i].equals("FIS_APP"))
			{
				int records = 0;
				try
				{
					records = com.cl.clzone.apps.fis.Fis_View_Request_Util.getReviewRequestCount(loginControl.getEmpId(),connection);
				}
				catch(Exception ex)
				{
					logCategory = Category.getInstance(PKG_NAME);
					logCategory.error(ex.toString());
					records = 0;
				}

				if(records>0)
				{
					buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
					buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
					buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/fis/fis_checkuser.jsp\""
										  + " class=\"lnkbld\">Claims</a><b><font class=\"lnkhed\">"  
										  + "(" + records + " Pending)</font></b></td></tr>");
				}
				else
				{
					buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
					buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
					buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/fis/fis_checkuser.jsp\""
										  + " class=\"lnkbld\">Claims</a></td></tr>");
				}
			}
			/*if(privilegeArray[i].equals("CB_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/cb/index.jsp\""
									  + " class=\"lnkbld\">CB Admin</a></td></tr>");
			}*/
			if(privilegeArray[i].equals("SIS_REP"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/sis/report/SISReport.jsp\" class=\"lnkbld\" title=\"Check the SIS Reports\">SIS Reports</a></td></tr>");

				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/sis/\" class=\"lnkbld\" title=\"Check TS Scores\">TS Scores</a></td></tr>");
			}
			if(privilegeArray[i].equals("SIS_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/admin/sis/bday/SISStudentBday.jsp\" class=\"lnkbld\" title=\"Send Birthday Meesages to the students of your center\">SIS- Send Birthday Wishes</a></td></tr>");
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/admin/sis/lostresults/index.jsp\" class=\"lnkbld\" title=\"Track Lost Testseries Scores\" target=\"_top\">SIS- Track Lost Testseries Scores</a></td></tr>");
			}
			// Add by giten 6/25/2003
			if(privilegeArray[i].equals("CB_AAT"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/aat/CBFacReport.jsp\" class=\"lnkbld\" title=\"Ask a teacher\">Ask-A-Teacher</a></td></tr>");
			}
			if(privilegeArray[i].equals("AAT_ADMIN"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
			buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/aat/admin/CBAdminHome.jsp\" class=\"lnkbld\" title=\"AAT-Admin\">AAT - Admin</a></td></tr>");
			}
			if(privilegeArray[i].equals("ERP_REPORT"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/reports/index.jsp\" class=\"lnkbld\" title=\"View ERP Reports\">Reports</a></td></tr>");
			}
			//end 6/25/2003

			//Added By Lovkesh 11 June, 2004
			if(privilegeArray[i].equals("FIN_REPORT"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/reports/finance/index.jsp\" class=\"lnkbld\" title=\"MIS Reports\">MIS Reports</a></td></tr>");
			}
			//end
// 9/21/2005 Added by kamal
			if(privilegeArray[i].equals("SMS_MOD"))
			{
				buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
				buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
				buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/admin/sms/SendEmployeeSMSPage.jsp\" class=\"lnkbld\">Send SMS</a>  <font class=\"new\">New !</font></td></tr>");
			}
			//end
		}


		buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
		buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/apps/complaint_system\" class=\"lnkbld\">Request System</a></td></tr>");
		buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
		buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/login/CLEmail.jsp\" target=\"_blank\" class=\"lnkbld\">Check Email</a></td></tr>");
		buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
		buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/cl.jsp?tp=/clzone/login/ChangePassword.html\" class=\"lnkbld\">Change Password</a></td></tr>");
		buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
		buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\"><a href=\"mailto:sujit@careerlauncher.com\" class=\"lnkbld\">Feedback</a></td></tr>");
		buffer.append(newline + "<tr><td colspan=\"3\"><img src=\"/img/blank.gif\" width=\"5\" height=\"5\"></td></tr>");
		buffer.append(newline + "<tr><td><img src=\"/msg/img/blank.gif\" width=\"5\" height=\"5\"></td>");
		buffer.append(newline + "<td colspan=\"2\"><a href=\"/clzone/login/logout.jsp\" class=\"lnkbld\">Logout</a></td></tr>");
		buffer.append(newline + "</table>");

		String tmp = "";
		tmp = buffer.toString();
		buffer = null;
		return tmp;
	}

	private int getPendingLeaveCount(int empId)
	{
		int cnt = 0;
		PreparedStatement pstmt = null;
		String sql = "select count(*) cnt from hris.cl_leave_detail a, hris.hris_emp_detail b"
						+ " where status = 'APPLIED' and a.emp_id = b.emp_id"
						+ " and b.emp_id_superior = ?";
		try
		{
			pstmt = connection.prepareStatement(sql);
			pstmt.setInt(1,empId);
			rset = pstmt.executeQuery();
			rset.next();
			cnt = rset.getInt("cnt");
		}
		catch (SQLException sqlEx)
		{
			cnt = 0;
		}
		finally
		{
			try{rset.close();}catch(Exception ex){}
			try{pstmt.close();}catch(Exception ex){}
		}
		return cnt;
	}

	private int getPendingAttdCount(int empId)
	{
		int cnt = 0;
		PreparedStatement pstmt = null;
		String sql = "select count(*) cnt from hris.cl_attd_data_change a, hris.hris_emp_detail b"
						+ " where change_status = 'REQ' and a.emp_id = b.emp_id"
						+ " and b.emp_id_superior = ?";
		try
		{
			pstmt = connection.prepareStatement(sql);
			pstmt.setInt(1,empId);
			rset = pstmt.executeQuery();
			rset.next();
			cnt = rset.getInt("cnt");
		}
		catch (SQLException sqlEx)
		{
			cnt = 0;
		}
		finally
		{
			try{rset.close();}catch(Exception ex){}
			try{pstmt.close();}catch(Exception ex){}
		}
		return cnt;
	}

	// this method will generate the folder list (both system as well as user created)
	// for the given user
	private String getFolders()
	{
		StringBuffer _buf = new StringBuffer(1000);
		int agentId = ((com.cl.msg.MSGAgent) pageContext.getSession().getAttribute("agent")).getAgentID();
		try
		{
			//first retrieve the system folders
			cstmt = connection.prepareCall("{call erp.sis_msg.get_system_folders(?)}");
			cstmt.registerOutParameter(1,OracleTypes.CURSOR);

			cstmt.execute();
			rset = (ResultSet) cstmt.getObject(1);
			int folderId = 0;
			String folderName = "";
			int folderMsgCount = 0;
			while(rset.next())
			{
				_buf.append("</td></tr>");
				folderId = rset.getInt("folder_id");
				folderName = rset.getString("folder_name");
				try
				{
					_cstmt = connection.prepareCall("{call erp.sis_msg.get_system_folder_msg_count(?,?,?,?)}");
					_cstmt.setInt(1,folderId);
					_cstmt.setInt(2,agentId);
					_cstmt.registerOutParameter(3,OracleTypes.NUMBER);	// total msg count
					_cstmt.registerOutParameter(4,OracleTypes.NUMBER);  // unread msg count

					_cstmt.execute();

					folderMsgCount = _cstmt.getInt(3);

					_cstmt.close();
				}
				catch(SQLException sql)
				{
					if(logCategory == null)
						logCategory = Category.getInstance(PKG_NAME);
					logCategory.error(sql.toString());
					folderMsgCount = 0;
				}
				finally
				{
					try
					{
						if(_cstmt != null)
							_cstmt.close();
					}
					catch(SQLException sql)
					{
						if(logCategory == null)
							logCategory = Category.getInstance(PKG_NAME);
						logCategory.error(sql.toString());
					}
				}
				_buf.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
//				_buf.append(newline + "<td><img src=\"/img/blank.gif\" width=\"5\"></td>");
				_buf.append(newline + "<td valign=\"top\" >");
				/* IMP: &fid=U U has been prefixed here to denote that 
				 * this folder id is one of the system folders 
				 */
				_buf.append(newline + "<a href=\"/msg/MSGInbox.jsp?cat=" + category + "&fldr=" 
									+ java.net.URLEncoder.encode(folderName) + "&fid=S" + folderId 
									+ "\" title=\"Folder " + folderName + "\"  class=\"highlighttext\">" 
									+ folderName + "</a> <font class=\"highlighttext\">(" + folderMsgCount + ")</font>");
				//Folder Id 3 is for Trash Can
				if(folderId == 3 && folderMsgCount > 0) 
					_buf.append(newline + "[<a href=\"/msg/MSGEmptyTrash.jsp?cat=" + category 
										+ "&fwd=totrash" + "\" title=\"Click here to empty your Trash Can\" class=\"highlighttext\">Empty</a>]");
				
				_buf.append("</td></tr>");
			}

			try{rset.close();}catch(Exception ex1){}
			try{cstmt.close();}catch(Exception ex1){}

			//now retrieve the user folders
			cstmt = connection.prepareCall("{call erp.sis_msg.get_user_folders(?,?)}");
			cstmt.registerOutParameter(1,OracleTypes.CURSOR);
			cstmt.setInt(2,agentId);

			cstmt.execute();
			rset = (ResultSet) cstmt.getObject(1);

			while(rset.next())
			{
				folderId = rset.getInt("folder_id");
				folderName = rset.getString("folder_name");

				_buf.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td>");
//				_buf.append(newline + "<td><img src=\"/img/blank.gif\" width=\"5\"></td>");
				_buf.append(newline + "<td valign=\"top\">");
				/* IMP: &fid=U U has been prefixed here to denote that this 
				 * folder id is one of the user created folders 
				 */
				_buf.append(newline + "<a href=\"/msg/MSGInbox.jsp?cat=" + category + "&fldr=" 
									+ java.net.URLEncoder.encode(folderName) + "&fid=U" 
									+ folderId + "\" title=\"Folder " 
									+ folderName + "\" class=\"highlighttext\">"
									+ folderName + "</a> <font class=\"highlighttext\">(" 
									+ rset.getInt("message_count") + ")</font></td></tr>");
			}
			try{rset.close();}catch(Exception ex1){}
			try{cstmt.close();}catch(Exception ex1){}

		}
		catch(SQLException sql)
		{
			if(logCategory == null)
				logCategory = Category.getInstance(PKG_NAME);
			logCategory.error(sql.toString());

			// logging the exception and displaying the inbox link to the user
			_buf = null;
			_buf = new StringBuffer(500);
			_buf.append(newline + "<tr><td><img src=\"/img/blank.gif\" width=\"5\"></td><td valign=\"top\" >");
			_buf.append(newline + "<a href=\"/msg/MSGInbox.jsp?cat=1&fid=1\" title=\"Folder Inbox\""
								    + "class=\"highlighttext\">Inbox</a></td></tr>");
		}
		finally
		{
			try{
				rset.close();
			}catch(SQLException sqle){}

			try{
				cstmt.close();
			}catch(SQLException sqle){}

		}
		String str = _buf.toString();
		_buf = null;
		return str;
	}

	private String[] getPrivileges()
	{
		String privilegeList = "";
		String[] privilegeArray = null;
		int locId;

		try
		{
			privilegeList = pageContext.getSession().getAttribute("privileges_type").toString();
		}
		catch(NullPointerException nlp)
		{
			privilegeArray = new String[1];
			privilegeArray[0] = "";
			return privilegeArray;
		}

		//privilegeList = "ERP_ADMIN,FRAN_APP,FMAP_ADMIN,HR_ADMIN,HR_DEFAULT,HR_DEFAULT,WEB_ADMIN,FIS_APP";
		
		StringTokenizer pToken = new StringTokenizer(privilegeList,",");
		privilegeArray = new String[pToken.countTokens()];
		
		int arrayCtr = 0;
		while(pToken.hasMoreTokens())
		{
			privilegeArray[arrayCtr] = pToken.nextToken();
			arrayCtr++; 
		}
		return privilegeArray;
	}

	public int doEndTag() throws JspTagException
	{
		return EVAL_PAGE;
	}


}
